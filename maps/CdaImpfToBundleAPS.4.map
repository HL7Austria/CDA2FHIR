map "http://hl7.at/fhir/HL7ATCoreProfiles/4.0.1/StructureMap/at-cda-to-bundle" = "CdaToBundle"

// Source 
uses "http://hl7.org/cda/stds/core/StructureDefinition/ClinicalDocument" alias ClinicalDocument as source
// Target 

uses "http://hl7.org/fhir/4.3/StructureDefinition/Bundle" alias Bundle as target
//uses "https://fhir.hl7.at/elga/aps/r4/StructureDefinition/at-aps-bundle" alias Bundle as target 

//uses "https://fhir.hl7.at/elga/aps/r4/StructureDefinition/at-aps-composition" alias Composition as target
uses "http://hl7.org/fhir/4.3/StructureDefinition/Immunization" alias Immunization as target
imports "http://hl7.at/fhir/HL7ATCoreProfiles/4.0.1/StructureMap/at-cda-to-fhir-types"


group CdaToFhirBundle(source cda: ClinicalDocument, target fhir_bundle: Bundle){
/*cda -> 
    fhir_bundle.id = uuid(),
    fhir_bundle.type = 'document',
    fhir_bundle.meta as fhir_bundle_meta,
    fhir_bundle_meta.profile = 'https://fhir.hl7.at/elga/aps/r4/StructureDefinition/at-aps-bundle' 
    "FhirBundleMetadata";
*/
//cda.id -> fhir_bundle.identifier "identifier";
cda.effectiveTime -> fhir_bundle.timestamp;
cda.id -> fhir_bundle.identifier; 
    



cda ->
    // create the composition to have it as reference for later transformations
    fhir_bundle.entry as fhir_bundle_entry_1,
    fhir_bundle_entry_1.resource = create('Composition') as fhir_composition
     "CDAtoFHIRBundle";
cda -> 
    fhir_bundle.entry as fhir_bundle_entry_2,
    fhir_bundle_entry_2.resource = create('Immunization') as fhir_immunization
    "CdaToFhirImmunization";


cda.component as cda_component then {
    cda_component.structuredBody as cda_structuredBody
    then(CdaBodyToFhirComposition(cda_structuredBody, fhir_composition, fhir_immunization, fhir_bundle));
};
}

group CdaBodyToFhirComposition(source cda_structuredBody: StructuredBody, target fhir_composition: Composition, target fhir_immunization: Immunization, target fhir_bundle: Bundle) {
    cda_structuredBody.component as cda_component then {
        cda_component.section as cda_section where code.where(code='11369-6' and codeSystem='2.16.840.1.113883.6.1') then CdaHistoryOfImmunizationSectionToFhirFhirCompositionSection(cda_section, fhir_composition, fhir_immunization, fhir_bundle);

    };
    }
group CdaHistoryOfImmunizationSectionToFhirFhirCompositionSection(source cda_section: Section, target fhir_composition: Composition, target fhir_immunization: Immunization, target fhir_bundle: Bundle) {
    //fhir_composition.section as fhir_composition_section;
    cda_section.entry as cda_entry then {
        cda_entry.substanceAdministration as cda_substanceAdministration where code.where(code='IMMUNIZ' and codeSystem='2.16.840.1.113883.5.4') then CdaSubstanceAdministrationToFhirImmunization(cda_substanceAdministration, fhir_immunization, fhir_composition, fhir_bundle);}
    };

group CdaSubstanceAdministrationToFhirImmunization(source cda_substanceAdministration: SubstanceAdministration, target fhir_immunization: Immunization, target fhir_composition: Composition, target fhir_bundle: Bundle) {
    cda_substanceAdministration.effectiveTime fhir_immunization.occurance;
}
/*group CDAToFhirImmunization(source cda: ClinicalDocument, target fhir_immunization: Immunization){

    



}*/



/*group CdaSectionImpfungToFhirCompositionSectionAps(source cda: ClinicalDocument, target fhir_composition: Composition){
    cda.section.title -> fhir_composition.section.title "title";
}*/