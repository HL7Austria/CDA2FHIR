map "http://hl7.at/fhir/HL7ATCoreProfiles/4.0.1/StructureMap/at-cda-to-bundle" = "CdaToBundle"

// Source 
uses "http://hl7.org/cda/stds/core/StructureDefinition/ClinicalDocument" alias ClinicalDocument as source
uses "http://hl7.org/cda/stds/core/StructureDefinition/Material" alias Material as source
// Target 

uses "http://hl7.org/fhir/4.3/StructureDefinition/Bundle" alias Bundle as target
//uses "https://fhir.hl7.at/elga/aps/r4/StructureDefinition/at-aps-bundle" alias Bundle as target 

//uses "https://fhir.hl7.at/elga/aps/r4/StructureDefinition/at-aps-composition" alias Composition as target
uses "http://hl7.org/fhir/4.3/StructureDefinition/Immunization" alias Immunization as target
imports "http://hl7.at/fhir/HL7ATCoreProfiles/4.0.1/StructureMap/at-cda-to-fhir-types"


group CdaToFhirBundle(source cda: ClinicalDocument, target fhir_bundle: Bundle){
/*cda -> 
    fhir_bundle.id = uuid(),
    fhir_bundle.type = 'document',
    fhir_bundle.meta as fhir_bundle_meta,
    fhir_bundle_meta.profile = 'https://fhir.hl7.at/elga/aps/r4/StructureDefinition/at-aps-bundle' 
    "FhirBundleMetadata";
*/
//cda.id -> fhir_bundle.identifier "identifier";
cda.effectiveTime -> fhir_bundle.timestamp;
cda.id -> fhir_bundle.identifier; 
cda ->
    // create the composition to have it as reference for later transformations
    fhir_bundle.entry as fhir_bundle_entry_1,
    fhir_bundle_entry_1.resource = create('Composition') as fhir_composition
     "CDAtoFHIRBundle";

cda.component as cda_component then {
    cda_component.structuredBody as cda_structuredBody
    then(CdaBodyToFhirComposition(cda_structuredBody, fhir_composition,  fhir_bundle));  
  };
}

group CdaBodyToFhirComposition(source cda_structuredBody: StructuredBody, target fhir_composition: Composition,  target fhir_bundle: Bundle) {
    cda_structuredBody.component as cda_component then {
        cda_component.section as cda_section where code.where(code='11369-6' and codeSystem='2.16.840.1.113883.6.1') -> fhir_composition.section as fhir_section then CdaHistoryOfImmunizationSectionToFhirCompositionSection(cda_section, fhir_section, fhir_bundle);
        cda_component.section as cda_history_of_past_illness_section where code.where(code='11348-0' and codeSystem='2.16.840.1.113883.6.1') -> fhir_composition.section as fhir_section_2 then CdaHistoryOfPastIllnessSectionToFhirCompositionSection(cda_history_of_past_illness_section, fhir_section_2, fhir_bundle);
    };
    }

group CdaHistoryOfPastIllnessSectionToFhirCompositionSection(source cda_history_of_past_illness_section: Section, source fhir_section_2, target fhir_bundle: Bundle) {

  // cda_section_of_past_illness_section -> 
  //  fhir_section_2.id as fhir_section_2_id,
  //  cda_history_of_past_illness_section.id as cda_section_id then  II(cda_section_id,fhir_section_2_id);
  cda_history_of_past_illness_section.title -> fhir_section_2.title;
  cda_history_of_past_illness_section.code -> fhir_section_2.code.coding;
  //cda_history_of_past_illness_section.text as cda_text -> fhir_section_2.text = (cda_text.xmlText)
  

  cda_history_of_past_illness_section.entry as cda_section_entry then {
  
     cda_section_entry.act as cda_act then {

      cda_act -> fhir_bundle.entry as fhir_bundle_entry_4,
      fhir_bundle_entry_4.resource = create('Condition') as fhir_condition,
      fhir_condition.id = uuid() as fhir_condition_id,
      fhir_bundle_entry_4.fullUrl = append('urn:uuid:', fhir_condition_id),
      fhir_section_2.entry = create('Reference') as fhir_section_entry_reference,
      fhir_section_entry_reference.reference = append('urn:uuid:', fhir_condition_id),
      fhir_section_entry_reference.type = 'Condition' then CdaImprelevanteErkankungenProblemEntry(cda_act, fhir_condition, fhir_bundle);
     };
   };
}
 

group CdaImprelevanteErkankungenProblemEntry(source cda_act: Act, target fhir_condition: Condition,target fhir_bundle: Bundle){

// 1…1 M	observation.id -> 0..* Condition.identifier
cda_act.id -> fhir_condition.identifier; 
// 1…1 M 	observation.code -> 0..1 code (Identification of the Problem.) !Fixer Wert - Problem (finding) 55607006
cda_act.code -> fhir_condition.code; 
// 1…1 M	observation.text(Narrative Text Reference - 1.2.40.0.34.6.0.11.9.1 ) ToDo
// 1…1 M	observation.statusCode.code !Fixer Wert "Completed"

// 1…1 M	observation.effectiveTime
// 0…1	observation.effectiveTime.low
// 0…1	observation.effectiveTime.low[@nullFlavor='UNK']
// 0…1 	observation.effectiveTime.high
// 1…1 M	observation.value 
// 1…1 R	observation.value.code
// 1…1 R	obseravtion.value.codeSystem
// 1…1 M	observation.value.originalText
// 0…1 C	observation.participant( Participant Body -Verifier  - 1.2.40.0.34.6.0.11.9.44) 
// 0…1 C	observation.participant (Participant Body - Authorized Editor - 1.2.40.0.34.6.0.11.9.46 )
// 0…1 C	observation.participant (Participant Body - Data Enterer - 1.2.40.0.34.6.0.11.9.47) 
// 0…1 	obervation.entryRelationship( Comment Entry - Single Author- 1.2.40.0.34.6.0.11.3.17 ) 

}

group CdaHistoryOfImmunizationSectionToFhirCompositionSection(source cda_section: Section, source fhir_section, target fhir_bundle: Bundle) extends CdaSectionToFhirSection {

  cda_section.entry as cda_section_entry then {
    // 1...* //component/structuredBody/component/section/entry/substanceAdministration - 1.2.40.0.34.6.0.11.3.1 Immunization Entry or  1.2.40.0.34.6.0.11.3.28 Immunization Entry Impfung nicht angegeben
    cda_section_entry.substanceAdministration as cda_substanceAdministration then {    

          // create Immunization
          cda_substanceAdministration -> fhir_bundle.entry as fhir_bundle_entry,
          fhir_bundle_entry.resource = create('Immunization') as fhir_immunization,
          fhir_immunization.id = uuid() as fhir_immunization_id,
          fhir_bundle_entry.fullUrl = append('urn:uuid:', fhir_immunization_id),
            fhir_section.entry = create('Reference') as fhir_section_entry_reference,
           fhir_section_entry_reference.reference = append('urn:uuid:', fhir_immunization_id),
           fhir_section_entry_reference.type = 'Immunization' then CdaSubstanceAdministrationToFhirImmunization(cda_substanceAdministration, fhir_immunization, fhir_bundle);

          // Encounter der zu der Immunization gehört. --> Noch nicht gemapped. 
          // cda_substanceAdministration.performer as cda_performer where $this.exists() -> fhir_bundle.entry as fhir_bundle_entry_2,
          // fhir_bundle_entry_2.resource = create('Encounter') as fhir_encounter,
          // fhir_encounter.id = uuid() as fhir_encounter_id,
          // fhir_bundle_entry_2.fullUrl = append('urn:uuid:', fhir_encounter_id),
          // fhir_immunization.encounter = create('Reference') as fhir_immunization_encounter,
          // fhir_immunization_encounter.reference = append('urn:uuid:', fhir_encounter_id),
          // fhir_immunization_encounter.type = 'Encounter',
           cda_substanceAdministration.performer as cda_performer where $this.exists() then {
            cda_performer -> fhir_bundle.entry as fhir_bundle_entry03,
            fhir_bundle_entry03.resource = create('PractitionerRole') as fhir_practitionerRole,
            fhir_practitionerRole.id = uuid() as fhir_practitionerRole_id,
            fhir_bundle_entry03.fullUrl = append('urn:uuid:', fhir_practitionerRole_id),
            fhir_immunization.performer as fhir_immunization_performer,
            fhir_immunization_performer.actor = create('Reference') as fhir_immunization_performer_actor,
            fhir_immunization_performer_actor.reference = append('urn:uuid:', fhir_practitionerRole_id),
            fhir_immunization_performer_actor.type = 'PractitionerRole' then CdaSubstanceAdministrationToPractitionerRole(cda_substanceAdministration,fhir_practitionerRole,fhir_bundle);
          };
          
         cda_substanceAdministration -> fhir_immunization.protocolApplied as fhir_protocolApplied then {

          //ClinicalDocument/component/structuredBody/component/section/entry/substanceAdministration/entryRelationship
          cda_substanceAdministration.entryRelationship as cda_entryRelationship,
          // ClinicalDocument/component/structuredBody/component/section/entry/substanceAdministration/entryRelationship/observation[templateId[@root='1.2.40.0.34.6.0.11.3.2']]
          cda_entryRelationship.observation as cda_observation where $this.templateId.where(root='1.2.40.0.34.6.0.11.3.2').exists() then {

            // 1…1 M 	//observation/code -> AtApsImmunization.protocolApplied.targetDisease
            cda_observation.code as cda_observation_code -> 
            fhir_protocolApplied.targetDisease as fhir_immunization_targetDisease then CECodeableConcept(cda_observation_code, fhir_immunization_targetDisease);
          };
          
          cda_substanceAdministration.precondition as cda_precondition,
          cda_precondition.criterion as cda_criterion then {
            
            // 1…1 	//criterion/code/@code -> AtApsImmunization.protocolApplied.series
            cda_criterion.code as cda_criterion_code where ($this.nullFlavor.exists().not()), cda_criterion_code.code as code ->
            fhir_protocolApplied.series = cast(code, 'string') as fhir_immunization_series,
            fhir_immunization_series.extension as fhir_series_extension,
            fhir_series_extension.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-codedString',
            // 1…1 	//criterion/code AtApsImmunization.protocolApplied.series.Coding
            fhir_series_extension.value = create('Coding') as extension_coding then {
            cda_criterion_code.code as code -> extension_coding.code = cast(code, 'string');
            cda_criterion_code.codeSystem as system -> extension_coding.system = translate(system, '#OIDtoURI', 'code');
            cda_criterion_code.displayName as display -> extension_coding.display = cast(display, 'string');
            // Hier .displayName --> CDA @displayName st	1 … 1	R
            cda_criterion.value as cda_criterion_value, cda_criterion_value.displayName as value_code -> 
            fhir_protocolApplied.doseNumberString = cast (value_code, 'string') as fhir_immunization_doseNumberString,
            fhir_immunization_doseNumberString.extension as fhir_doseNumber_extension,
            fhir_doseNumber_extension.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-codedString',
            fhir_doseNumber_extension.value = create('Coding') as extension_coding then CECoding(cda_criterion_value,extension_coding);
            };
          }; 
        };
      };        
};}

group CdaSubstanceAdministrationToFhirImmunization(source cda_substanceAdministration: SubstanceAdministration, target fhir_immunization: Immunization,  target fhir_bundle: Bundle) {
    
  /*
      ToDo: 
      - 1...1 M 	//substanceAdministration/text


    */
    //1..1 M 	//substanceAdministration/id --> AtApsImmunization.identifier 
    cda_substanceAdministration.id -> fhir_immunization.identifier;
    // 1..1 M 	//substanceAdministration/statusCode[@code='completed']		Fixer Wert: 'Completed' --> AtApsImmunization.status
    cda_substanceAdministration.statusCode -> fhir_immunization.status;
    // 1..1 M 	//substanceAdministration/effectiveTime --> AtApsImmunization. occurrenceDateTime
    cda_substanceAdministration.effectiveTime as cda_effectiveTime -> fhir_immunization.occurrence = create('dateTime') as fhir_immunization_occurrence then TSDateTime(cda_effectiveTime, fhir_immunization_occurrence) "CdaEffectiveTimeToFhirImmunizationOccurrence";
    // 0...1 	//substanceAdministration/routeCode --> AtApsImmunization.route
    cda_substanceAdministration.routeCode as cda_routeCode where ($this.nullFlavor.exists().not()) -> fhir_immunization.route;
    // 0...1 	//substanceAdministration/doseQuantity --> AtApsImmunization.doseQuantity
    // NullFlavor at cda_doseQuantity - Level --> Assumption that nested DataTypes do not have a NullFlavor
    cda_substanceAdministration.doseQuantity as cda_doseQuantity where ($this.nullFlavor.exists().not()) -> fhir_immunization.doseQuantity;
    // //substanceAdministration/consumable
    cda_substanceAdministration.consumable as cda_consumable,
    //substanceAdministration/consumable/manufacturedProduct
    cda_consumable.manufacturedProduct as cda_manufacturedProduct then {
        // Gruppe die manuFacturedProduct zu FHIR Immunization Mapped. 
      cda_manufacturedProduct then CdaManufacturedMaterialToFhirImmunizationMedication(cda_manufacturedProduct, fhir_immunization, fhir_bundle);
    };

    cda_manufacturedProduct.manufacturedMaterial as cda_manufacturedMaterial then {

      // 1...1 R 	manufracturedProduct.ManufacturedMaterial.code --> AtApsImmunization.vaccineCode
      // fhir_immunization.vaccineCode.text --> Werte werden nicht übernommen.
      // substanceAdministration - consumable: Vaccine Product nicht angegeben - 1.2.40.0.34.6.0.11.9.31
      cda_manufacturedMaterial.code where ($this.nullFlavor = 'NA') then {
        cda_manufacturedMaterial.code as cda_manufacturedMaterial_code,
        cda_manufacturedMaterial_code.nullFlavor ->
        fhir_immunization.vaccineCode as fhir_immunization_vaccineCode,
        fhir_immunization_vaccineCode.extension as fhir_immunization_vaccineCode_extension then CdaNullFlavorToFhirNullFlavor(cda_manufacturedMaterial_code, fhir_immunization_vaccineCode_extension)
        "CdaManufacturedMaterialCodeNullFlavorToFhirImmunizationVaccineCodeDataAbsentReason"; 
      }; 
      
      cda_manufacturedMaterial.code where ($this.nullFlavor.exists().not()) then {

        cda_manufacturedMaterial.code as cda_manufacturedMaterial_code ->
        fhir_immunization.vaccineCode as fhir_immunization_vaccineCode then CECodeableConcept(cda_manufacturedMaterial_code, fhir_immunization_vaccineCode);

        // "0...1" //manufacturedProduct/manufacturedMaterial/lotNumberText -> AtApsImmunization.lotNumber
        cda_manufacturedMaterial.lotNumberText where ($this.nullFlavor.exists().not()) -> fhir_immunization.lotNumber;
    
        cda_manufacturedProduct.manufacturerOrganization as cda_manufacturerOrganization then {
    
          cda_manufacturerOrganization ->
            fhir_bundle.entry as fhir_bundle_entry,
            fhir_bundle_entry.resource = create('Organization') as fhir_organization,
            fhir_organization.id = uuid() as fhir_organization_id,
            fhir_bundle_entry.fullUrl = append('urn:uuid:', fhir_organization_id),
            fhir_immunization.manufacturer = create('Reference') as fhir_immunization_organization,
            fhir_immunization_organization.reference = append('urn:uuid:', fhir_organization_id),
            fhir_immunization_organization.type = 'Organization' then
            CdaOrganizationCompilationToFhirOrganization(cda_manufacturerOrganization, fhir_organization);
        };
      };
    };
  }


group CdaManufacturedMaterialToFhirImmunizationMedication(source cda_manufacturedProduct : ManufacturedProduct, target fhir_immunization : Immunization, target fhir_bundle : Bundle) {
  
  // //manufacturedProduct/manufacturedMaterial
  // cda_manufacturedProduct.manufacturedMaterial as cda_manufacturedMaterial then {
   
  // cda_manufacturedMaterial.pharmIngredient as cda_ingredient
  //     where $this.exists() ->
  //       fhir_bundle.entry as fhir_bundle_entry_1,
  //       fhir_bundle_entry_1.resource = create('Medication') as fhir_medication,
  //       fhir_medication.id = uuid() as fhir_medication_id,
  //       fhir_bundle_entry_1.fullUrl = append('urn:uuid:', fhir_medication_id),

  //       fhir_immunization.extension as fhir_administeredProduct_extension,
  //       fhir_administeredProduct_extension.url = 'http://hl7.org/fhir/5.0/StructureDefinition/extension-Immunization.administeredProduct',
  //       fhir_administeredProduct_extension.extension as fhir_reference_extension,
  //       fhir_reference_extension.url = 'reference',
  //       fhir_reference_extension.value = create('Reference') as fhir_reference_value,
  //       fhir_reference_value.reference = append('urn:uuid:', fhir_medication_id),
  //       fhir_reference_value.type = 'Medication' then {
  //         cda_ingredient.pharmIngredient as cda_ingredient_ingredient then {

  //           // Noch nicht funktionsbereit. 
  //           //substanceAdministration//manufacturedProduct/id
  //           cda_manufacturedProduct.id -> fhir_medication.identifier; 
  //           // fhir_medication.ingredient as fhir_medication_ingredient,
  //           // fhir_medication_ingredient.item as fhir_medication_ingredient_item,
  //           // fhir_medication_ingredient_item.itemCodeableConcept as fhir_medication_ingredient_item_codeableConcept;
               // //manufacturedMaterial/pharm:ingredient/pharm:ingredient/pharm:code -> Medication.ingredient.item.itemCodeableConcept.coding
  //           // //cda_ingredient_ingredient.code -> fhir_medication_ingredient_item_codeableConcept.code;
               // 0…1	//manufacturedMaterial/pharm:ingredient/pharm:ingredient/pharm:name ->  Medication.ingredient.item.itemCodeableConcept.text
  //           //cda_ingredient_ingredient.name -> fhir_medication_ingredient_item_codeableConcept.text; 

  //         };
          
  //     };
  // };

}

group CdaSectionToFhirSection(source cda_section: Section, target fhir_section, target fhir_bundle: Bundle) {
  // section.templateId
  // TODO necessary?
  // section.id
  // TODO extension?

  // section.code
  // TODO mapping on CTS required from https://termgit.elga.gv.at/ValueSet/elga-laborstruktur to http://fhir.ehdsi.eu/laboratory/ValueSet/eHDSILabStudyTypeWithExceptions
  cda_section.code -> fhir_section.code;
  
  // section.title
  cda_section.title as cda_section_title -> fhir_section.title = (cda_section_title.xmlText) "test";
  // section.text
  cda_section.text as cda_section_text ->
    fhir_section.text as fhir_section_text,
    fhir_section_text.status = 'generated' then {
      // section.text where no section.languageCode exists
      cda_section_text where cda_section.languageCode.exists().not() -> fhir_section_text.div = cda_section_text "asdf";

      // section.text with section.languageCode
      cda_section_text where cda_section.languageCode.exists() then {
        cda_section.languageCode as cda_languageCode then {
          cda_languageCode.code as cda_languageCode_code ->

            // as long as TODO below has not been solved
            fhir_section_text.div = cda_section_text "asdf";
            // TODO fix output:
            //   Currently, the output will look like <div xml:lang="XX"><div xmlns="http://www.w3.org/1999/xhtml">section.text</div></div>
            //   However, the div-tag with the xml:lang should be within the div-tag with the xmlns.
            //
            //  fhir_section_text.div = append('<div xml:lang="', cda_languageCode_code, '">', cda_section_text, '</div>') "asdf";
        };
      } "CdaSectionTextToFhirSectionTextWithLanguage";
    };
  // section.author
  cda_section.author as cda_section_author ->
    // create the PractitionerRole in order to capture the author
    fhir_bundle.entry as fhir_bundle_entry,
    fhir_bundle_entry.resource = create('PractitionerRole') as fhir_practitionerRole,
    fhir_practitionerRole.id = uuid() as fhir_practitionerRole_id,
    fhir_bundle_entry.fullUrl = append('urn:uuid:', fhir_practitionerRole_id),
    fhir_section.author = create('Reference') as fhir_section_author_reference,
    fhir_section_author_reference.reference = append('urn:uuid:', fhir_practitionerRole_id),
    fhir_section_author_reference.type = 'PractitionerRole' then
    CdaAuthorToFhirPractitionerRole(cda_section_author, fhir_practitionerRole, fhir_bundle); //hinzufügen der PractitionerRole

}


group CdaAuthorToFhirPractitionerRole(source cda_author : Author, target fhir_practitionerRole : PractitionerRole, target fhir_bundle : Bundle){
  cda_author ->
    // create the Practitioner
    fhir_bundle.entry as fhir_bundle_entry,
    fhir_bundle_entry.resource = create('Practitioner') as fhir_practitioner,
    fhir_practitioner.id = uuid() as fhir_practitioner_id,
    fhir_bundle_entry.fullUrl = append('urn:uuid:', fhir_practitioner_id),
    fhir_practitionerRole.practitioner = create('Reference') as fhir_practitionerRole_practitioner_reference,
    fhir_practitionerRole_practitioner_reference.reference = append('urn:uuid:', fhir_practitioner_id),
    fhir_practitionerRole_practitioner_reference.type = 'Practitioner' then {

      // ClinicalDocument.author.functionCode
      // TODO in CDA no value set is specified for this element, so mapping is not possible as it could be any code
      //      in FHIR (MyHealth@EU Lab) however a required binding for this optional element exits
      // cda_author.functionCode -> fhir_practitionerRole.code;

      // ClinicalDocument.author.time
      // TODO extension?
      // ClinicalDocument.author.time
      // TODO nullFlavor? http://hl7.org/fhir/R4/extension-data-absent-reason.html
      // ClinicalDocument.author.assignedAuthor
      cda_author.assignedAuthor as cda_author_assignedAuthor then {
        // ClinicalDocument.author.assignedAuthor.id
        cda_author_assignedAuthor.id -> fhir_practitioner.identifier;
        // ClinicalDocument.author.assignedAuthor.code
        cda_author_assignedAuthor.code as cda_author_assignedAuthor_code ->
          fhir_practitioner.qualification as fhir_practitioner_qualification,
          fhir_practitioner_qualification.code as fhir_practitioner_qualification_code then
          CECodeableConcept(cda_author_assignedAuthor_code,fhir_practitioner_qualification_code);
        // ClinicalDocument.author.assignedAuthor.telecom
        cda_author_assignedAuthor.telecom -> fhir_practitioner.telecom;
        // ClinicalDocument.author.assignedAuthor.assignedPerson
        cda_author_assignedAuthor.assignedPerson as cda_assignedPerson then {
          cda_assignedPerson.name -> fhir_practitioner.name;
        };
        // ClinicalDocument.author.assignedAuthor.representedOrganization
        cda_author_assignedAuthor.representedOrganization as cda_representedOrganization ->
          fhir_bundle.entry as fhir_bundle_entry,
          fhir_bundle_entry.resource = create('Organization') as fhir_organization,
          fhir_organization.id = uuid() as fhir_organization_id,
          fhir_bundle_entry.fullUrl = append('urn:uuid:', fhir_organization_id),
          fhir_practitionerRole.organization = create('Reference') as fhir_practitionerRole_organization,
          fhir_practitionerRole_organization.reference = append('urn:uuid:', fhir_organization_id),
          fhir_practitionerRole_organization.type = 'Organization' then
          CdaOrganizationCompilationToFhirOrganization(cda_representedOrganization, fhir_organization);
      };
    } "CdaAuthorToFhirPractitionerRole";
}

group CdaSubstanceAdministrationToPractitionerRole(source cda_substanceAdministration: SubstanceAdministration, target fhir_practitionerRole: PractitionerRole, target fhir_bundle: Bundle) {

  cda_substanceAdministration.performer as cda_performer then {
    cda_performer.assignedEntity as cda_assignedEntity then CdaAssignedEntityToFhirPractitionerRole(cda_assignedEntity, fhir_practitionerRole, fhir_bundle);
  }

}

group CdaAssignedEntityToFhirPractitionerRole(source cda_assignedEntity : AssignedEntity, target fhir_practitionerRole : PractitionerRole, target fhir_bundle : Bundle){
  cda_assignedEntity ->
    // create the Practitioner
    fhir_bundle.entry as fhir_bundle_entry,
    fhir_bundle_entry.resource = create('Practitioner') as fhir_practitioner,
    fhir_practitioner.id = uuid() as fhir_practitioner_id,
    fhir_bundle_entry.fullUrl = append('urn:uuid:', fhir_practitioner_id),
    fhir_practitionerRole.practitioner = create('Reference') as fhir_practitionerRole_practitioner_reference,
    fhir_practitionerRole_practitioner_reference.reference = append('urn:uuid:', fhir_practitioner_id),
    fhir_practitionerRole_practitioner_reference.type = 'Practitioner' then {
      // assignedEntity.id
      cda_assignedEntity.id -> fhir_practitionerRole.identifier;

      // assignedEntity.code - TODO here "external" laboratories (performer) could be identified - best place?
      // TODO in CDA no value set is specified for this element, so mapping is not possible as it could be any code
      //      in FHIR (MyHealth@EU Lab) however a required binding for this optional element exits
      // cda_assignedEntity.code -> fhir_practitionerRole.code;

      // assignedEntity.addr
      cda_assignedEntity.addr -> fhir_practitioner.address;
      // assignedEntity.telecom
      cda_assignedEntity.telecom -> fhir_practitioner.telecom;
      // assignedEntity.assignedPerson
      cda_assignedEntity.assignedPerson as cda_assignedPerson then {
        // assignedEntity.assignedPerson.name
        cda_assignedPerson.name -> fhir_practitioner.name;
      };
      // assignedEntity.representedOrganization
      cda_assignedEntity.representedOrganization as cda_representedOrganization ->
        fhir_bundle.entry as fhir_bundle_entry,
        fhir_bundle_entry.resource = create('Organization') as fhir_organization,
        fhir_organization.id = uuid() as fhir_organization_id,
        fhir_bundle_entry.fullUrl = append('urn:uuid:', fhir_organization_id),
        fhir_practitionerRole.organization = create('Reference') as fhir_practitionerRole_organization,
        fhir_practitionerRole_organization.reference = append('urn:uuid:', fhir_organization_id),
        fhir_practitionerRole_organization.type = 'Organization' then
        CdaOrganizationCompilationToFhirOrganization(cda_representedOrganization, fhir_organization);
  } "CdaAssignedEntityToFhirPractitionerRole";
}